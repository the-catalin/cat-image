<link rel="import" href="../polymer/polymer.html">
 
<dom-module id="cat-image">
    <style>
        :host {
            display: block;
            overflow: hidden;
            position: relative;
        }
        #img {
            height: 100%;
            transition-duration: 3s;
            transition-timing-function: ease-in-out;
            position: relative;
        }        
        #txt {
            position: absolute;
            top: 0;    
        }

        #txt p {
            margin: 10px 0 ;
        }
        #txt p:first-child {
            margin-top: 0;
        }
        #txt p:last-child {
            margin-bottom: 0;
        }

        /* css preloaderÂ */
        .cssload-spin-box {
            margin: auto;
            position: absolute;
            margin: auto;
            left: 0;
            top: 0;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            border-radius: 100%;
            box-shadow: 10px 10px rgb(79,77,73), -10px 10px rgb(223,223,223), -10px -10px rgb(79,77,73), 10px -10px rgb(223,223,223);
            animation: cssload-spin ease infinite 4.6s;
        }
        @keyframes cssload-spin {
            0%,
            100% {box-shadow: 10px 10px rgb(79,77,73), -10px 10px rgb(223,223,223), -10px -10px rgb(79,77,73), 10px -10px rgb(223,223,223);}
            25% {box-shadow: -10px 10px rgb(223,223,223), -10px -10px rgb(79,77,73), 10px -10px rgb(223,223,223), 10px 10px rgb(79,77,73);}
            50% {box-shadow: -10px -10px rgb(79,77,73), 10px -10px rgb(223,223,223), 10px 10px rgb(79,77,73), -10px 10px rgb(223,223,223);}
            75% {box-shadow: 10px -10px #dfdfdf, 10px 10px #4f4d49, -10px 10px #dfdfdf, -10px -10px #4f4d49;}
        }

    </style>

    <template>
        <div class="cssload-spin-box"></div>
        <div id="img"></div>
        <div id="txt"></div>
    </template>
    
    <script>

    (function(){

    'use strict';
    
    var positions = {
            'center': '50% 50%',
            'top-left': '20% 20%',
            'top-right': '80% 20%',
            'bottom-left': '20% 80%',
            'bottom-right': '80% 80%'
        },
        posIndexes = ['center', 'top-left', 'top-right', 'bottom-left', 'bottom-right'],
        horizontalPositions = ['center', 'left', 'right'],
        verticalPositions = ['center', 'top', 'bottom'];
    

    Polymer({
        
        lightDom: [],

        // using a temp image to trigger a callback when the image is loaded
        tempImg : document.createElement('img'),

        onImageLoaded: function(callback) {
            if (this.tempImg && this.tempImg.complete) {
                callback();
            } else {
                this.tempImg.addEventListener('load', callback);
            }
        },

        is: 'cat-image',

        properties: {
            src: String,
            useKenBurns: Boolean,
            kenBurnsZoomDirection: String,
            transitionDuration: Number,
            transitionDelay: Number,
            zoomOrigin: String,
            zoomScale: {
                type: Number,
                value: 10
            },
            horizontalTextPosition: String,
            verticalTextPosition: String,
            textPadding: Number,
            showEffectsOnHover: Boolean
        },

        errorHandling: function() {
            if (posIndexes.indexOf(this.zoomOrigin) === -1) {
                this.zoomOrigin = 'random';
            }
            if (horizontalPositions.indexOf(this.horizontalTextPosition) === -1) {
                this.horizontalTextPosition = 'random';
            }
            if (verticalPositions.indexOf(this.verticalTextPosition) === -1) {
                this.verticalTextPosition = 'random';
            }
            if (this.kenBurnsZoomDirection !== 'in') {
                this.kenBurnsZoomDirection = 'out';
            }
            if (this.textPadding === undefined) {
                textPadding = 20;
            }
        },

        setImageAsBackground: function() {
            this.$.img.style.background = "url('" + this.src +"') no-repeat center center";
            this.$.img.style.backgroundSize = 'cover';                
            
            this.tempImg.setAttribute('src', this.src);        
        },

        appendTextChildren: function() {
            //append cat-text child elements to #txt div
            this.lightDom = Polymer.dom(this).children;
            for (var i = 0; i < this.lightDom.length; i++) {
                var paragraph = document.createElement('p');
                paragraph.appendChild(this.lightDom[i]);
                Polymer.dom(this.$.txt).appendChild(paragraph);
            }
        },

        attachListeners: function() {
            if (this.showEffectsOnHover) {
                this.listen(this, 'mouseenter', 'onMouseEnter');
                this.listen(this, 'mouseleave', 'onMouseLeave');
            }
        },

        initialStyleSetup: function() {
            var rand;
            if (this.useKenBurns) {
                this.scale = (100 + this.zoomScale) / 100;

                if (this.kenBurnsZoomDirection === 'out') {
                    this.$.img.style.transform = 'scale3d(' + this.scale + ', ' + this.scale + ', 1)';
                }
            }

            if (this.horizontalTextPosition === 'random') {
                rand = Math.floor(Math.random() * 3);
                this.horizontalTextPosition = horizontalPositions[rand];
            }
            if (this.verticalTextPosition === 'random') {
                rand = Math.floor(Math.random() * 3);
                this.verticalTextPosition = verticalPositions[rand];
            }
            if (this.horizontalTextPosition === 'right') {
                this.$.txt.style.right = 0;
                this.$.txt.style.textAlign = 'right';
            }
            if (this.horizontalTextPosition === 'center') {
                this.$.txt.style.left = 0;
                this.$.txt.style.right = 0;
                this.$.txt.style.marginLeft = 'auto';
                this.$.txt.style.marginRight = 'auto';
                this.$.txt.style.textAlign = 'center';
            }
            if (this.verticalTextPosition === 'bottom') {
                this.$.txt.style.bottom = 0;
                this.$.txt.style.top = 'auto';
            }
            if (this.verticalTextPosition === 'center') {
                this.$.txt.style.top = '50%';
                this.$.txt.style.transform = 'translate(0, -50%)';
            }

            this.$.txt.style.padding = this.textPadding + 'px';
        },

        ready: function() {
            this.errorHandling();
            this.setImageAsBackground();
            this.appendTextChildren();
            this.attachListeners();
            this.initialStyleSetup();
        },

        kenBurnsInitStyle: function() {
            var self = this,
                rand;

            this.$.img.style.transitionDuration = this.transitionDuration + 's';
            this.$.img.style.transitionDelay = this.transitionDelay + 's';
            this.$.img.style.transitionProperty = 'transform';
            
            if (this.zoomOrigin === 'random') {
                rand = Math.floor(Math.random() * 5);
                this.$.img.style.transformOrigin = positions[posIndexes[rand]];
            } else {
                this.$.img.style.transformOrigin = positions[this.zoomOrigin];
            }

        },

        showKenBurns: function() {
            if (this.kenBurnsZoomDirection === 'out') {
                this.$.img.style.transform = 'scale3d(1, 1, 1)';
            } else {
                this.$.img.style.transform = 'scale3d(' + this.scale + ', ' + this.scale + ', 1)';
            }
        },

        hideKenBurns: function() {
            if (this.kenBurnsZoomDirection === 'out') {
                this.$.img.style.transform = 'scale3d(' + this.scale + ', ' + this.scale + ', 1)';
            } else {
                this.$.img.style.transform = 'scale3d(1, 1, 1)';
            }
        },

        attached: function() {
            var self = this;

            if (self.useKenBurns) {
                self.kenBurnsInitStyle();
                
                if (!self.showEffectsOnHover) {
                    self.onImageLoaded(function() {
                        onVisibleOnce(self, function() {
                            self.showInfoText();
                            self.showKenBurns();
                        });
                    });
                } else {
                    self.onImageLoaded(function() {
                        if (self.mouseIsOver) {
                            self.showInfoText();
                            self.showKenBurns();
                        }
                    });
                }
            }
        },
        showInfoText: function() {
            for (var i = 0; i < this.lightDom.length; i++) {
                this.lightDom[i].fire('show');
            }
        },
        hideInfoText: function() {
            for (var i = 0; i < this.lightDom.length; i++) {
                this.lightDom[i].fire('hide');
            }
        },
        onMouseEnter: function() {
            this.mouseIsOver = true;

            if (this.tempImg && this.tempImg.complete) {
                this.showInfoText();
                this.showKenBurns();
            }
        },
        onMouseLeave: function() {
            this.mouseIsOver = false;

            if (this.tempImg && this.tempImg.complete) {
                this.hideInfoText();
                this.hideKenBurns();
            }
        }
    });

    // functions to check if an element is in the viewport
    function isElementInViewport(el) {       
        var rect = el.getBoundingClientRect();
        return (
            rect.top >= 0 &&
            rect.left >= 0 &&
            rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
            rect.right <= (window.innerWidth || document.documentElement.clientWidth)
        );
    }

    function onVisibleOnce(el, callback) {            
        var visibilityCheck = function() {
            if (isElementInViewport(el)) {
                callback();
                removeEventListener('DOMContentimgLoaded', visibilityCheck, false); 
                removeEventListener('load', visibilityCheck, false); 
                removeEventListener('scroll', visibilityCheck, false); 
                removeEventListener('resize', visibilityCheck, false);
            }
        };

        addEventListener('DOMContentimgLoaded', visibilityCheck, false); 
        addEventListener('load', visibilityCheck, false); 
        addEventListener('scroll', visibilityCheck, false); 
        addEventListener('resize', visibilityCheck, false);

        visibilityCheck();
    }
    //

    })();
    </script>

</dom-module>
